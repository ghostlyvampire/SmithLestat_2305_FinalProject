import pygame
from sys import exit
import os

#game variables
TILE_SIZE = 32
GAME_WIDTH = 512
GAME_HEIGHT = 512

PLAYER_DISTANCE = 5
PLAYER_X = GAME_WIDTH/2
PLAYER_Y = GAME_HEIGHT/2
PLAYER_WIDTH = 28
PLAYER_HEIGHT = 28

PLAYER_BULLET_WIDTH = 24
PLAYER_BULLET_HEIGHT = 24
PLAYER_BULLET_VELOCITY_X = 8

#gravity
GRAVITY = 0.5
FRICTION = 0.5
PLAYER_VELOCITY_X = 5
PLAYER_VELOCITY_Y = -12
FLOOR_Y = GAME_HEIGHT - TILE_SIZE

#enemies
GHOST_WIDTH = 28
GHOST_HEIGHT = 28
GHOST_BULLET_WIDTH = 24
GHOST_BULLET_HEIGHT = 24
GHOST_BULLET_VELOCITY_X = 4

#images
def load_image(image_name, scale=None):
    image = pygame.image.load(os.path.join(image_name))
    if scale is not None:
        image = pygame.transform.scale(image, scale)
    return image      

background_image = load_image("background.jpg", (GAME_WIDTH, GAME_HEIGHT))
ghost_image_left = load_image("ghost.png", (GHOST_WIDTH, GHOST_HEIGHT))
player_image_right = load_image("clown.png", (PLAYER_WIDTH, PLAYER_HEIGHT))
player_image_bullet = load_image("bullet.png", (PLAYER_BULLET_WIDTH, PLAYER_BULLET_HEIGHT))
ghost_image_bullet = load_image("ghostbullet.png", (GHOST_BULLET_WIDTH, GHOST_BULLET_HEIGHT))
floor_tile_image = load_image("floor-tile.jpg", (TILE_SIZE, TILE_SIZE))

pygame.init()
window = pygame.display.set_mode((GAME_WIDTH, GAME_HEIGHT))
pygame.display.set_caption("2D Platformer")
pygame.display.set_icon(player_image_right)
clock = pygame.time.Clock()
game_over = False

#custome event
INVINCIBLE_END = pygame.USEREVENT + 0
SHOOTING_END = pygame.USEREVENT + 1

class Player(pygame.Rect):
    class Bullet(pygame.Rect):
        def __init__(self):
            pygame.Rect.__init__(self, player.x, player.y, PLAYER_BULLET_WIDTH, PLAYER_BULLET_HEIGHT)
            self.velocity_x = PLAYER_BULLET_VELOCITY_X
            self.image = player_image_bullet
            self.used = False

    def __init__(self):
        pygame.Rect.__init__(self, PLAYER_X, PLAYER_Y, PLAYER_WIDTH, PLAYER_HEIGHT)
        self.image = player_image_right
        self.velocity_x = 0
        self.velocity_y = 0
        self.jumping = False
        self.invincible = False
        self.max_health = 26
        self.health = self.max_health
        self.shooting = False
        self.bullets = []

    def set_invincible(self, milliseconds=1000):
        self.invincible = True      
        pygame.time.set_timer(INVINCIBLE_END, milliseconds, 1)

    def set_shooting(self):
        if not self.shooting:
            self.shooting = True
            self.bullets.append(Player.Bullet())       
            pygame.time.set_timer(SHOOTING_END, 350, 1)

class Ghost(pygame.Rect):
    class Bullet(pygame.Rect):
        def __init__(self, ghost):
            pygame.Rect.__init__(self, ghost.x, ghost.y, GHOST_BULLET_WIDTH, GHOST_BULLET_HEIGHT)
            self.velocity_x = -GHOST_BULLET_VELOCITY_X
            self.image = ghost_image_bullet
            self.used = False

    def __init__(self, x, y):
        pygame.Rect.__init__(self, x, y, GHOST_WIDTH, GHOST_HEIGHT)
        self.image = ghost_image_left
        self.velocity_y = 0
        self.jumping = False
        self.health = 3
        self.bullets = []
        self.shooting = False
        self.last_fired = pygame.time.get_ticks()

    def set_shooting(self):
        now = pygame.time.get_ticks()
        if now - self.last_fired > 1200:  
            self.last_fired = now          
            self.shooting = True
            self.bullets.append(Ghost.Bullet(self))


class Tile(pygame.Rect):
    def __init__(self, x, y, image):
        pygame.Rect.__init__(self, x, y, TILE_SIZE, TILE_SIZE)
        self.image = image

def create_map():
    #right platform 1
    for i in range(4):
        tile = Tile(player.x + i*TILE_SIZE + 130, player.y + TILE_SIZE*4, floor_tile_image)
        tiles.append(tile)

    #right platform 2
    for i in range(1):
        tile = Tile(player.x + i*TILE_SIZE + 190, player.y + TILE_SIZE*4 - 100, floor_tile_image)
        tiles.append(tile)

    #right platform 3
    for i in range(2):
        tile = Tile(player.x + i*TILE_SIZE + 125, player.y + TILE_SIZE*4 - 200, floor_tile_image)
        tiles.append(tile)      

    #left platform 1
    for i in range(4):
        tile = Tile(player.x + i*TILE_SIZE - 256, player.y + TILE_SIZE*4, floor_tile_image)
        tiles.append(tile)

    #left platform 2
    for i in range(3):
        tile = Tile(player.x + i*TILE_SIZE - 192, player.y + TILE_SIZE*4 - 100, floor_tile_image)
        tiles.append(tile)

    #left platform 3
    for i in range(2):
        tile = Tile(player.x + i*TILE_SIZE - 256, player.y + TILE_SIZE*4 - 200, floor_tile_image)
        tiles.append(tile)     

    #Starting platform
    for i in range(2):
        tile = Tile(player.x + i*TILE_SIZE - 16, player.y + TILE_SIZE*4 - 100, floor_tile_image)
        tiles.append(tile)

    #floor
    for i in range(16):
        tile = Tile(player.x - GAME_WIDTH/2 + i*TILE_SIZE, player.y + TILE_SIZE*7, floor_tile_image)
        tiles.append(tile)

    #ghosts
    for i in range(3):
        ghost = Ghost(player.x + TILE_SIZE*(3 + i*2), TILE_SIZE*6)
        ghosts.append(ghost)

def reset_game():
    global player, ghosts, tiles, game_over
    player = Player()
    ghosts = []
    tiles = []
    create_map()
    game_over = False

def check_tile_collision(character):
    for tile in tiles:
        if character.colliderect(tile):
            return tile
    return None     

def check_tile_collision_x(character):
    tile = check_tile_collision(character)
    if tile is not None:
        if character.velocity_x < 0:
            character.x = tile.x + tile.width
        elif character.velocity_x > 0:
            character.x = tile.x - character.width
        character.velocity_x = 0           

def check_tile_collision_y(character):
    tile = check_tile_collision(character)
    if tile is not None:
        if character.velocity_y < 0:
            character.y = tile.y + tile.height
        elif character.velocity_y > 0:
            character.y = tile.y - character.height
            character.jumping = False
        character.velocity_y = 0

def move():
    global ghosts, game_over

    #player movement
    if player.velocity_x < 0:
        player.velocity_x += FRICTION
    elif player.velocity_x > 0:
        player.velocity_x -= FRICTION
    else:
        player.velocity_x = 0

    player.x += player.velocity_x
    if player.x <0:
        player.x =0
    elif player.x + player.width > GAME_WIDTH:
        player.x = GAME_WIDTH - player.width

    check_tile_collision_x(player)

    player.velocity_y += GRAVITY
    player.y += player.velocity_y
    
    check_tile_collision_y(player)

    if player.y + player.height > FLOOR_Y:
        player.y = FLOOR_Y - player.height
        player.jumping = False

    #bullets
    for bullet in player.bullets:
        bullet.x += bullet.velocity_x
        for ghost in ghosts:
            if ghost.health > 0 and not bullet.used and bullet.colliderect(ghost):
                ghost.health -= 1
                bullet.used = True

    player.bullets = [bullet for bullet in player.bullets if not bullet.used]
    ghosts = [ghost for ghost in ghosts if ghost.health>0]

    #enemy movement
    for ghost in ghosts:
        ghost.velocity_y += GRAVITY    
        ghost.y += ghost.velocity_y
        check_tile_collision_y(ghost)

        #collision between characters
        if player.colliderect(ghost) and not player.invincible:
            player.health -= 3
            player.set_invincible()

        #enemy bullets
        ghost.set_shooting()
        for bullet in ghost.bullets:
            bullet.x += bullet.velocity_x 
            if not player.invincible and player.colliderect(bullet):
                player.health -= 5
                bullet.used = True
                player.set_invincible   

        ghost.bullets = [bullet for bullet in ghost.bullets if not bullet.used]  

    #game over
    if player.health <= 0:
        game_over = True;         

def main():
    window.fill("blue")
    window.blit(background_image, (0,0))

    for tile in tiles:
        window.blit(tile.image, tile)

    window.blit(player.image, player)

    for bullet in player.bullets:
        window.blit(bullet.image, bullet)

    for ghost in ghosts:
        window.blit(ghost.image, ghost) 
        for bullet in ghost.bullets:
            window.blit(bullet.image, bullet)
         
    pygame.draw.rect(window, "black", (TILE_SIZE, TILE_SIZE, 10 * player.max_health, 10))    
    pygame.draw.rect(window, "red", (TILE_SIZE, TILE_SIZE, 10 * player.health, 10))     

#start game
player = Player()
ghosts = []
tiles = []
create_map()

while True:
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            pygame.quit()
            exit()

        if event.type == INVINCIBLE_END:
            player.invincible = False  
        elif event.type == SHOOTING_END:
            player.shooting = False          

    keys = pygame.key.get_pressed()
    if (keys[pygame.K_r] and game_over):
        reset_game()

    if keys[pygame.K_UP] and not player.jumping:
        player.velocity_y = PLAYER_VELOCITY_Y
        player.jumping = True

    if keys[pygame.K_LEFT]:
        player.velocity_x = -PLAYER_VELOCITY_X

    if keys[pygame.K_RIGHT]:
        player.velocity_x = PLAYER_VELOCITY_X

    if keys[pygame.K_SPACE]:
        player.set_shooting()                                     
    
    if not game_over:
        move()
        main()
        pygame.display.update()   
        clock.tick(60)     